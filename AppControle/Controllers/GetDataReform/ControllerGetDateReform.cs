using AppControle.Models;
using AppControle.Models.GetData;
using AppControle.Models.GetDataReform;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using OfficeOpenXml;
using System.Runtime.Intrinsics.Wasm;

[Route("api/getDataReform")]
[ApiController]

public class GetDataReformController : ControllerBase
{
    private readonly AcessControlContext _context;

    public GetDataReformController(AcessControlContext Context)
    {
        _context = Context;
    }

    [HttpPost]
    public async Task<ActionResult> PostReform (IFormFile File)
    {
        if (File == null)
        {
            return BadRequest("Arquivo não encontrado");
        }

        using(var strem = new MemoryStream())
        {
            await File.CopyToAsync(strem); ;
            using (var package = new ExcelPackage(strem))
            {
                var worksheet = package.Workbook.Worksheets[0];
                var rowCount = worksheet.Dimension.Rows;

                for (int i = 2; i <= rowCount; i++)
                {
                    var codObra = worksheet.Cells[i, 1].Text;
                    var obra = worksheet.Cells[i, 2].Text;
                    var ctr = int.TryParse(worksheet.Cells[i, 3].Text, out var codContrato) ? codContrato : (int?)null;
                    var pacote = worksheet.Cells[i, 4].Text;
                    var empresa = worksheet.Cells[i, 5].Text;
                    var codItem = int.TryParse(worksheet.Cells[i, 6].Text, out var codItens) ? codItens : 0;
                    var codSevice = worksheet.Cells[i, 7].Text;
                    var descService = worksheet.Cells[i, 8].Text;
                    var qtd = double.TryParse(worksheet.Cells[i, 9].Text, out var quantidade) ? quantidade : (double?)null;
                    var obs = worksheet.Cells[i, 10].Text;

                    var getDateReform = new GetDateReform
                    {
                        Data = DateTime.Now,
                        CodObra = codObra,
                        Obra = obra,
                        Ctr = ctr,
                        Pacote = pacote,
                        Empresa = empresa,
                        CodItem = codItem,
                        CodService = codSevice,
                        DescService = descService,
                        Qtd = qtd,
                        Obs = obs,
                    };

                    _context.GetDateReform.Add(getDateReform);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                }

                await _context.SaveChangesAsync();
            }
        }

        return Ok("Dados importados com sucesso.");
    }

    [HttpGet]
    public async Task<ActionResult<IEnumerable<GetDateReform>>> GetAllDateReform()
    {
        return await _context.GetDateReform.Select(x => ItemDTOReform(x)).ToListAsync();
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<GetDateReform>> GetReformById(int id)
    {
        var Usuario = await _context.GetDateReform.FindAsync(id);

        if (Usuario == null)
        {
            return NotFound();
        }

        return ItemDTOReform(Usuario);
    }

    private static GetDateReform ItemDTOReform(GetDateReform getDateReform) =>
    new GetDateReform
    {
        Id = getDateReform.Id,
        Data = getDateReform.Data,
        CodObra = getDateReform.Obra,
        Obra = getDateReform.Obra,
        Ctr = getDateReform.Ctr,
        Pacote = getDateReform.Pacote,
        Empresa = getDateReform.Empresa,
        CodItem = getDateReform.CodItem,
        CodService = getDateReform.CodService,
        DescService = getDateReform.DescService,
        Qtd = getDateReform.Qtd,
        Obs = getDateReform.Obs,
    };
}